<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>JRS-HNRe - Dashboard de Gerenciamento</title>

  <!-- 1. Importação de Fontes (Google Fonts) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Carlito:ital,wght@0,400;0,700;1,400&family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
  
  <!-- 2. Importação de Ícones (Material Symbols) -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

  <!-- 3. Importação do Material Design 3 (M3) será feita no JS -->
  <!-- <script type="module" src="https://cdn.jsdelivr.net/npm/@material/web@1.4.1/material-web.js"></script> --> <!-- REMOVIDO DAQUI -->

  <!-- 4. Importação do Google Charts Loader -->
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <!-- 
  ================================================================
  CSS (Estilização) - Etapa 3
  ================================================================
  -->
  <style>
    /* --- 1. Definições Globais e Paleta de Cores --- */
    :root {
      /* Identidade Visual */
      --app-primary-color: #050F41; /* Cor principal (Header) */
      --app-secondary-color: #4A6E8A; /* Tom de azul/cinza Marinha */
      --app-tertiary-color: #B0C4DE; /* Azul claro para destaques */
      
      /* Cores do Material 3 (Base) */
      --md-sys-color-primary: var(--app-primary-color);
      --md-sys-color-on-primary: #FFFFFF;
      --md-sys-color-primary-container: #DCE1FF;
      --md-sys-color-on-primary-container: #001550;
      
      --md-sys-color-secondary: var(--app-secondary-color);
      --md-sys-color-on-secondary: #FFFFFF;
      --md-sys-color-secondary-container: #D8E4F7;
      --md-sys-color-on-secondary-container: #1C314A;

      --md-sys-color-tertiary: var(--app-tertiary-color);
      --md-sys-color-on-tertiary: #003355;
      --md-sys-color-tertiary-container: #CDE5FF;
      --md-sys-color-on-tertiary-container: #001D33;

      --md-sys-color-background: #F8F9FF; /* Fundo levemente azulado/cinza */
      --md-sys-color-on-background: #1A1C20;
      
      --md-sys-color-surface: #F8F9FF;
      --md-sys-color-on-surface: #1A1C20;
      
      --md-sys-color-surface-variant: #E1E2EC;
      --md-sys-color-on-surface-variant: #44474F;

      --md-sys-color-outline: #74777F;
      --md-sys-color-outline-variant: #C4C6D0;

      /* Cores Semânticas */
      --app-error-color: #B3261E;
      --app-success-color: #146C2E;
      --app-warning-color: #FF9800;

      /* Fontes */
      --app-font-title: 'Montserrat', sans-serif;
      --app-font-body: 'Carlito', sans-serif;
    }

    /* --- 2. Reset e Estilos Base --- */
    body {
      font-family: var(--app-font-body);
      background-color: var(--md-sys-color-background);
      color: var(--md-sys-color-on-background);
      margin: 0;
      padding-top: 80px; /* Espaço para o header fixo */
      box-sizing: border-box;
    }

    h1, h2, h3, h4 {
      font-family: var(--app-font-title);
      color: var(--app-primary-color);
    }
    
    h3 {
      font-weight: 500;
      font-size: 1.25rem;
      border-bottom: 2px solid var(--md-sys-color-outline-variant);
      padding-bottom: 8px;
    }

    /* --- 3. Header Fixo --- */
    #app-header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 72px; /* Altura aumentada para logo e texto */
      background-color: var(--app-primary-color);
      color: var(--md-sys-color-on-primary);
      display: flex;
      align-items: center;
      padding: 0 24px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      box-sizing: border-box;
    }

    #app-header img {
      height: 56px; /* Logo com 56px de altura */
      width: auto;
      margin-right: 16px;
    }

    #app-header .header-title h1 {
      font-family: var(--app-font-title);
      color: white;
      font-size: 1.5rem; /* H1: 24px */
      font-weight: 700;
      margin: 0;
      line-height: 1.2;
    }
    
    #app-header .header-title h2 {
      font-family: var(--app-font-body); /* Corpo (Carlito) */
      color: white;
      font-size: 1rem; /* H2: 16px */
      font-weight: 400;
      margin: 0;
      line-height: 1.2;
    }

    /* --- 4. Layout Principal --- */
    main {
      display: grid;
      grid-template-columns: 1fr; /* Coluna única por padrão (mobile) */
      gap: 16px;
      padding: 16px;
      max-width: 1600px;
      margin: 0 auto;
    }

    .container-box {
      background-color: var(--md-sys-color-surface);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* --- 5. Seção de Filtros --- */
    #filtros-inputs {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
      align-items: center;
    }

    #filtros-inputs md-filled-button {
      /* Faz o botão se alinhar melhor com os inputs */
      margin-top: 8px; 
      min-height: 56px;
    }
    
    /* --- 6. Seção de KPIs (Etapa 1/4) --- */
    #kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .kpi-card {
      padding: 16px;
    }

    .kpi-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: var(--md-sys-color-on-surface-variant);
      font-family: var(--app-font-title);
      font-weight: 500;
      text-transform: uppercase;
      font-size: 0.8rem;
    }

    .kpi-card-value {
      font-family: var(--app-font-title);
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--app-primary-color);
      margin: 8px 0;
    }

    .kpi-card-variation {
      display: flex;
      align-items: center;
      font-size: 0.85rem;
      font-weight: 700;
    }

    .kpi-card-variation.positive {
      color: var(--app-success-color);
    }
    .kpi-card-variation.negative {
      color: var(--app-error-color);
    }
    .kpi-card-variation.neutral {
      color: var(--md-sys-color-on-surface-variant);
    }
    .kpi-card-variation md-icon {
      font-size: 1rem;
      margin-right: 4px;
    }

    /* --- 7. Seção de Gráficos (Etapa 4) --- */
    #charts-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }
    .chart-wrapper {
      width: 100%;
      height: 350px;
    }

    /* --- 8. Seção da Tabela CRUD (Etapa 5) --- */
    .table-wrapper {
      width: 100%;
      overflow-x: auto;
      border: 1px solid var(--md-sys-color-outline-variant);
      border-radius: 8px;
    }

    #crud-table {
      width: 100%;
      border-collapse: collapse;
    }

    #crud-table th, #crud-table td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--md-sys-color-outline-variant);
      font-family: var(--app-font-body);
    }

    #crud-table th {
      font-family: var(--app-font-title);
      font-weight: 700;
      font-size: 0.8rem;
      text-transform: uppercase;
      color: var(--md-sys-color-on-surface-variant);
      background-color: var(--md-sys-color-surface-variant);
    }
    
    #crud-table tr:last-child td {
      border-bottom: none;
    }
    
    #crud-table tr:hover {
      background-color: var(--md-sys-color-surface-variant);
    }

    /* --- 9. Componentes Auxiliares (Loading, Diálogos) --- */
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    
    #loading-overlay.visible {
      opacity: 1;
      visibility: visible;
    }
    
    #loading-overlay md-circular-progress {
      --md-circular-progress-size: 64px;
    }
    
    #loading-overlay span {
      color: white;
      font-family: var(--app-font-title);
      font-size: 1.2rem;
      margin-top: 16px;
    }

    #crud-dialog-form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    /* --- 10. Assessor Normativo (Etapa 6) --- */
    #assessor-content md-list {
      background-color: transparent;
      padding: 0;
    }
    #assessor-content md-list-item {
      --md-list-item-container-color: transparent;
    }
    #assessor-content md-list-item md-icon[slot="start"] {
      color: var(--app-warning-color);
    }

    /* --- 11. Responsividade --- */

    /* Desktop (Layout de 2 colunas para gráficos e assessor) */
    @media (min-width: 960px) {
      /* Layout principal em 2 colunas */
      main {
        grid-template-columns: repeat(2, 1fr);
      }
      
      /* Filtros ocupam a linha inteira (2 colunas) */
      #filtros-container {
        grid-column: 1 / -1;
      }
      
      /* KPIs ocupam a linha inteira */
      #kpi-container {
        grid-column: 1 / -1;
      }
      
      /* Assessor e Tendência Mensal na primeira coluna */
      #assessor-container {
        grid-column: 1 / 2;
      }
      #chart-tendencia-container {
        grid-column: 1 / 2;
      }
      
      /* Outros gráficos na segunda coluna */
      #charts-grid {
        grid-column: 2 / 3;
        grid-template-columns: 1fr; /* Gráficos empilhados na 2a coluna */
      }
      
      /* Tabela ocupa a linha inteira */
      #tabela-container {
        grid-column: 1 / -1;
      }
    }
    
    /* Telas Maiores (Layout de 3 colunas) */
    @media (min-width: 1400px) {
      /* Layout principal em 3 colunas */
      main {
        grid-template-columns: repeat(3, 1fr);
      }
      
      /* Filtros ocupam a linha inteira */
      #filtros-container {
        grid-column: 1 / -1;
      }
      
      /* KPIs ocupam a linha inteira */
      #kpi-container {
        grid-column: 1 / -1;
      }
      
      /* Assessor na Coluna 1 */
      #assessor-container {
        grid-column: 1 / 2;
      }
      
      /* Gráfico de Tendência na Coluna 2 */
      #chart-tendencia-container {
        grid-column: 2 / 3;
      }
      
      /* Outros gráficos na Coluna 3 */
      #charts-grid {
        grid-column: 3 / 4;
      }
      
      /* Tabela ocupa a linha inteira */
      #tabela-container {
        grid-column: 1 / -1;
      }
    }

  </style>
</head>
<body>

  <!-- 
  ================================================================
  HTML (Esqueleto) - Etapas 3, 4, 5, 6
  ================================================================
  -->

  <!-- 1. Overlay de Loading Global -->
  <div id="loading-overlay">
    <md-circular-progress indeterminate></md-circular-progress>
    <span>Carregando dados...</span>
  </div>

  <!-- 2. Header Fixo -->
  <header id="app-header">
    <img src="https://i.imgur.com/KUbQz08.png" alt="Logo Marinha do Brasil">
    <div class="header-title">
      <h1>JUNTA REGULAR de SAÚDE</h1>
      <h2>HOSPITAL NAVAL DE RECIFE</h2>
    </div>
  </header>

  <!-- 3. Conteúdo Principal -->
  <main>

    <!-- 4. Seção de Filtros -->
    <section id="filtros-container" class="container-box">
      <h3><md-icon slot="icon">filter_list</md-icon> Filtros</h3>
      <div id="filtros-inputs">
        <!-- Filtros serão renderizados aqui pelo JS (Etapa 4) -->
      </div>
    </section>
    
    <!-- 5. Seção de KPIs -->
    <section id="kpi-container" class="container-box">
      <h3><md-icon slot="icon">dashboard</md-icon> Dashboard de Indicadores</h3>
      <div id="kpi-grid">
        
        <!-- KPI 1 -->
        <md-elevated-card class="kpi-card">
          <div class="kpi-card-header">
            <span>Agendadas/Remarcadas</span>
            <md-icon>event</md-icon>
          </div>
          <div id="kpi-agendadas-value" class="kpi-card-value">0</div>
        </md-elevated-card>
        
        <!-- KPI 2 -->
        <md-elevated-card class="kpi-card">
          <div class="kpi-card-header">
            <span>Em Auditoria/JSD</span>
            <md-icon>search</md-icon>
          </div>
          <div id="kpi-auditoria-value" class="kpi-card-value">0</div>
        </md-elevated-card>
        
        <!-- KPI 3 -->
        <md-elevated-card class="kpi-card">
          <div class="kpi-card-header">
            <span>MSG Pendente</span>
            <md-icon>notification_important</md-icon>
          </div>
          <div id="kpi-msg-value" class="kpi-card-value">0</div>
        </md-elevated-card>
        
        <!-- KPI 4 (com variação) -->
        <md-elevated-card class="kpi-card">
          <div class="kpi-card-header">
            <span>Laudos Assinados</span>
            <md-icon>assignment_turned_in</md-icon>
          </div>
          <div id="kpi-laudos-value" class="kpi-card-value">0</div>
          <div id="kpi-laudos-variation" class="kpi-card-variation neutral">
            <md-icon>horizontal_rule</md-icon>
            <span>--% vs Mês Ant.</span>
          </div>
        </md-elevated-card>
        
        <!-- KPI 5 (com variação) -->
        <md-elevated-card class="kpi-card">
          <div class="kpi-card-header">
            <span>Faltas</span>
            <md-icon>person_off</md-icon>
          </div>
          <div id="kpi-faltas-value" class="kpi-card-value">0</div>
          <div id="kpi-faltas-variation" class="kpi-card-variation neutral">
            <md-icon>horizontal_rule</md-icon>
            <span>--% vs Mês Ant.</span>
          </div>
        </md-elevated-card>

        <!-- KPI 6 (com variação) -->
        <md-elevated-card class="kpi-card">
          <div class="kpi-card-header">
            <span>Canceladas</span>
            <md-icon>event_busy</md-icon>
          </div>
          <div id="kpi-canceladas-value" class="kpi-card-value">0</div>
          <div id="kpi-canceladas-variation" class="kpi-card-variation neutral">
            <md-icon>horizontal_rule</md-icon>
            <span>--% vs Mês Ant.</span>
          </div>
        </md-elevated-card>
      </div>
    </section>

    <!-- 6. Seção Assessor Normativo (Etapa 6) -->
    <section id="assessor-container" class="container-box">
      <h3><md-icon slot="icon">support_agent</md-icon> Alertas do Assessor (DGPM-406)</h3>
      <div id="assessor-content">
        <!-- Conteúdo dinâmico (Etapa 6) -->
        <md-linear-progress indeterminate id="assessor-loading" style="display: none;"></md-linear-progress>
        <md-list id="assessor-list"></md-list>
      </div>
    </section>
    
    <!-- 7. Seção de Gráficos (Agrupados) -->
    <div id="chart-tendencia-container" class="container-box">
      <h3>Tendência Mensal de Inspeções</h3>
      <div id="chart-tendencia" class="chart-wrapper"></div>
    </div>
    
    <section id="charts-grid" class="container-box">
      <h3>Distribuição de Dados</h3>
      
      <h4>Por Finalidade</h4>
      <div id="chart-finalidade" class="chart-wrapper"></div>
      
      <h4>Por Status de Inspeção</h4>
      <div id="chart-status" class="chart-wrapper"></div>
      
      <h4>Por OM</h4>
      <div id="chart-om" class="chart-wrapper"></div>
    </section>

    <!-- 8. Seção da Tabela CRUD -->
    <section id="tabela-container" class="container-box">
      <h3><md-icon slot="icon">table_rows</md-icon> Controle de Inspeções (CRUD)</h3>
      <div class="table-wrapper">
        <table id="crud-table">
          <thead>
            <!-- Cabeçalho (Etapa 5) -->
            <tr>
              <th>Status</th>
              <th>MSG</th>
              <th>Data (Entrevista)</th>
              <th>Inspecionado</th>
              <th>Finalidade</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="crud-table-body">
            <!-- Linhas de dados (Etapa 5) -->
          </tbody>
        </table>
      </div>
    </section>

  </main>

  <!-- 
  ================================================================
  DIÁLOGOS (Pop-ups) - Etapas 5 e 6
  ================================================================
  -->

  <!-- Diálogo para Ações CRUD (Etapa 5) -->
  <md-dialog id="crud-dialog">
    <div slot="headline" id="crud-dialog-title">Editar Inspeção</div>
    <form id="crud-dialog-form" slot="content" method="dialog">
      <!-- Conteúdo do formulário será injetado aqui pelo JS -->
    </form>
    <div slot="actions">
      <md-text-button form="crud-dialog-form" value="cancel">Cancelar</md-text-button>
      <md-filled-button id="crud-dialog-save" value="save">Salvar</md-filled-button>
    </div>
  </md-dialog>
  
  <!-- Diálogo para Erros (Etapa 4) -->
  <md-dialog id="error-dialog">
    <div slot="headline">Erro na Aplicação</div>
    <div slot="content" id="error-dialog-message">
      Ocorreu um erro inesperado.
    </div>
    <div slot="actions">
      <md-filled-button form="error-dialog" value="ok">Entendido</md-filled-button>
    </div>
  </md-dialog>
  
  
  <!-- 
  ================================================================
  JAVASCRIPT (Lógica do Cliente) - Etapas 4, 5 e 6
  ================================================================
  -->
  <script type="module">
    // --- CORREÇÃO: Importa o M3 aqui para garantir o carregamento ---
    import "https://cdn.jsdelivr.net/npm/@material/web@1.4.1/material-web.js";
  
    // --- Variáveis Globais e Referências de DOM ---
    const loadingOverlay = document.getElementById('loading-overlay');
    const errorDialog = document.getElementById('error-dialog');
    const errorDialogMessage = document.getElementById('error-dialog-message');
    const crudDialog = document.getElementById('crud-dialog');
    const crudDialogTitle = document.getElementById('crud-dialog-title');
    const crudDialogForm = document.getElementById('crud-dialog-form');
    const crudDialogSaveButton = document.getElementById('crud-dialog-save');
    const tableHeader = document.querySelector("#crud-table thead");
    const tableBody = document.getElementById('crud-table-body');
    
    // Elementos de KPI
    const kpiAgendadas = document.getElementById('kpi-agendadas-value');
    const kpiAuditoria = document.getElementById('kpi-auditoria-value');
    const kpiMsgPendente = document.getElementById('kpi-msg-value');
    const kpiLaudos = document.getElementById('kpi-laudos-value');
    const kpiFaltas = document.getElementById('kpi-faltas-value');
    const kpiCanceladas = document.getElementById('kpi-canceladas-value');
    
    // Container dos Filtros
    const filtrosContainer = document.getElementById('filtros-inputs');
    
    // --- ETAPA 6: Referências de DOM ---
    const assessorLoading = document.getElementById('assessor-loading');
    const assessorList = document.getElementById('assessor-list');
    
    // Estado Global
    let appData = {
      table: [],
      ref: {}
    };
    
    // Opções Padrão dos Gráficos (Alinhado com a Identidade Visual)
    const chartBaseOptions = {
      fontName: 'Carlito',
      fontSize: 12,
      backgroundColor: 'transparent',
      titleTextStyle: {
        fontName: 'Montserrat',
        fontSize: 14,
        color: 'var(--app-primary-color)'
      },
      legend: { position: 'none' },
      colors: ['var(--app-primary-color)', 'var(--app-secondary-color)', 'var(--app-tertiary-color)'],
      hAxis: { 
        textStyle: { color: 'var(--app-on-surface-variant-color)' },
        gridlines: { color: 'transparent' }
      },
      vAxis: { 
        textStyle: { color: 'var(--app-on-surface-variant-color)' },
        gridlines: { color: 'var(--app-surface-variant-color)' },
        minValue: 0
      },
      chartArea: { width: '80%', height: '80%' }
    };

    // --- Inicialização ---

    // 1. Espera o DOM carregar
    document.addEventListener('DOMContentLoaded', () => {
      // 2. Carrega a API do Google Charts
      google.charts.load('current', {'packages':['corechart', 'line']});
      // 3. Define o callback para quando a API de gráficos estiver pronta
      google.charts.setOnLoadCallback(initializeApp);
    });

    /**
     * 3. Função principal de inicialização da aplicação.
     */
    function initializeApp() {
      console.log("App inicializado. Carregando dados...");
      renderFilterInputs(); // Cria os inputs de filtro
      setupEventListeners(); // Adiciona listeners aos filtros
      
      // Adiciona listeners para o CRUD
      setupCrudListeners(); 
      
      loadRefData(); // Carrega dados para os dropdowns
      loadDashboardData(); // Carrega os dados principais (KPIs, Gráficos)
    }

    // --- Funções de Carregamento de Dados (API) ---

    /**
     * Busca os dados de referência (filtros) do backend.
     */
    function loadRefData() {
      showLoading(true); // Mostra loading
      google.script.run
        .withSuccessHandler(onRefDataSuccess)
        .withFailureHandler(onApiFailure)
        .getRefData();
    }

    /**
     * Busca os dados principais (KPIs, Gráficos, Tabela) do backend.
     */
    function loadDashboardData() {
      showLoading(true);
      
      // Coleta os valores atuais dos filtros
      const filters = {
        dataInicio: document.getElementById('filtro-data-inicio').value,
        dataFim: document.getElementById('filtro-data-fim').value,
        finalidade: document.getElementById('filtro-finalidade').value,
        om: document.getElementById('filtro-om').value,
        statusIS: document.getElementById('filtro-status').value
      };
      
      console.log("Enviando filtros:", filters);
      
      google.script.run
        .withSuccessHandler(onDataSuccess)
        .withFailureHandler(onApiFailure)
        .getSheetData(filters);
    }

    // --- Callbacks de Sucesso e Falha da API ---

    /**
     * Callback de sucesso para getRefData().
     * @param {object} refData Os dados para os filtros.
     */
    function onRefDataSuccess(refData) {
      console.log("Dados de Referência recebidos:", refData);
      appData.ref = refData;
      
      // Popula os dropdowns
      populateSelect('filtro-finalidade', refData.finalidades, "Todas Finalidades");
      populateSelect('filtro-om', refData.om, "Todas OMs");
      populateSelect('filtro-status', refData.status, "Todos Status");
      
      // Não escondemos o loading aqui, pois o onDataSuccess o fará.
    }

    /**
     * Callback de sucesso para getSheetData().
     * @param {object} data O objeto com { kpis, chartsData, tableData }.
     */
    function onDataSuccess(data) {
      console.log("Dados do Dashboard recebidos:", data);
      
      // Guarda os dados da tabela para a Etapa 5
      appData.table = data.tableData;

      // 1. Atualiza os KPIs
      updateKpis(data.kpis);
      
      // 2. Desenha os Gráficos
      drawCharts(data.chartsData);
      
      // 3. Renderiza a Tabela (Implementação da Etapa 5)
      renderTable(data.tableData);
      
      // 4. --- ETAPA 6.A ---
      // Chama o Assessor Normativo com os dados da tabela
      loadAssessorAlerts(data.tableData);
      // --- FIM ETAPA 6.A ---
      
      showLoading(false); // Esconde o loading
    }
    
    /**
     * Callback de falha para CQUALQUER chamada ao google.script.run.
     * @param {Error} error O objeto de erro.
     */
    function onApiFailure(error) {
      console.error("Falha na API:", error.message);
      showLoading(false);
      showError("Erro de Comunicação", `Não foi possível completar a ação. Verifique a conexão ou o log do Apps Script. Detalhe: ${error.message}`);
    }

    // --- ETAPA 6.A: Funções do Assessor Normativo (Dashboard) ---

    /**
     * [ETAPA 6.A] Chama o backend para obter os alertas do assessor.
     * @param {object[]} tableData Os dados da tabela para análise.
     */
    function loadAssessorAlerts(tableData) {
      console.log("[Etapa 6.A] Solicitando alertas do Assessor...");
      assessorLoading.style.display = 'block'; // Mostra loading dos alertas
      assessorList.innerHTML = ''; // Limpa alertas antigos
      
      google.script.run
        .withSuccessHandler(onAssessorSuccess)
        .withFailureHandler(onAssessorFailure)
        .getAssessoriaNormativa(tableData);
    }
    
    /**
     * [ETAPA 6.A] Callback de sucesso para getAssessoriaNormativa.
     * @param {string[]} alertas Array de strings (bullet points).
     */
    function onAssessorSuccess(alertas) {
      console.log("[Etapa 6.A] Alertas recebidos:", alertas);
      assessorLoading.style.display = 'none';
      
      if (!alertas || alertas.length === 0) {
        assessorList.innerHTML = `<md-list-item><div slot="headline">Nenhum ponto de atenção normativo identificado.</div></md-list-item>`;
      } else {
        assessorList.innerHTML = alertas.map(alerta => `
          <md-list-item>
            <md-icon slot="start">warning_amber</md-icon>
            <div slot="headline">${alerta}</div>
          </md-list-item>
        `).join('');
      }
    }
    
    /**
     * [ETAPA 6.A] Callback de falha para getAssessoriaNormativa.
     */
    function onAssessorFailure(error) {
      console.error("[Etapa 6.A] Falha ao buscar alertas:", error.message);
      assessorLoading.style.display = 'none';
      assessorList.innerHTML = `
        <md-list-item>
          <md-icon slot="start">error</md-icon>
          <div slot="headline" style="color: var(--app-error-color);">Falha ao contatar Assessor: ${error.message}</div>
        </md-list-item>
      `;
    }

    // --- Renderização de Componentes (Filtros, KPIs, Gráficos) ---

    /**
     * Cria e injeta o HTML dos componentes de filtro na página.
     */
    function renderFilterInputs() {
      // Define o período padrão: 1º dia do mês atual até hoje.
      const { startDate, endDate } = getDefaultDateRange();
      
      filtrosContainer.innerHTML = `
        <md-outlined-text-field label="Data Início" type="date" id="filtro-data-inicio" value="${startDate}"></md-outlined-text-field>
        <md-outlined-text-field label="Data Fim" type="date" id="filtro-data-fim" value="${endDate}"></md-outlined-text-field>
        
        <md-outlined-select label="Finalidade" id="filtro-finalidade">
          <md-select-option value="" selected>Todas Finalidades</md-select-option>
          <!-- Opções carregadas por loadRefData -->
        </md-outlined-select>
        
        <md-outlined-select label="OM" id="filtro-om">
          <md-select-option value="" selected>Todas OMs</md-select-option>
          <!-- Opções carregadas por loadRefData -->
        </md-outlined-select>
        
        <md-outlined-select label="Status da IS" id="filtro-status">
          <md-select-option value="" selected>Todos Status</md-select-option>
          <!-- Opções carregadas por loadRefData -->
        </md-outlined-select>
        
        <md-filled-button id="btn-filtrar">
          <md-icon slot="icon">search</md-icon>
          Filtrar
        </md-filled-button>
      `;
    }

    /**
     * Configura os event listeners para os filtros.
     */
    function setupEventListeners() {
      // Botão principal de filtro
      document.getElementById('btn-filtrar').addEventListener('click', loadDashboardData);
      
      // Interatividade: Atualiza ao mudar qualquer filtro (evento 'change' nos M3)
      document.getElementById('filtro-data-inicio').addEventListener('change', loadDashboardData);
      document.getElementById('filtro-data-fim').addEventListener('change', loadDashboardData);
      document.getElementById('filtro-finalidade').addEventListener('change', loadDashboardData);
      document.getElementById('filtro-om').addEventListener('change', loadDashboardData);
      document.getElementById('filtro-status').addEventListener('change', loadDashboardData);
    }

    /**
     * Atualiza os valores nos cards de KPI.
     * @param {object} kpis O objeto de KPIs vindo do backend.
     */
    function updateKpis(kpis) {
      kpiAgendadas.textContent = kpis.agendadas;
      kpiAuditoria.textContent = kpis.auditoria;
      kpiMsgPendente.textContent = kpis.msgPendente;
      
      // KPIs com Variação
      kpiLaudos.textContent = kpis.laudoAssinado.total;
      renderKpiVariation(
        document.getElementById('kpi-laudos-variation'), 
        kpis.laudoAssinado.variacao
      );
      
      kpiFaltas.textContent = kpis.faltas.total;
      renderKpiVariation(
        document.getElementById('kpi-faltas-variation'), 
        kpis.faltas.variacao
      );
      
      kpiCanceladas.textContent = kpis.canceladas.total;
      renderKpiVariation(
        document.getElementById('kpi-canceladas-variation'), 
        kpis.canceladas.variacao
      );
    }

    /**
     * Helper para renderizar a variação (MoM) em um KPI card.
     * @param {HTMLElement} element O <div> que conterá a variação.
     * @param {number} variacao O valor percentual da variação.
     */
    function renderKpiVariation(element, variacao) {
      element.innerHTML = ''; // Limpa
      let icon = 'horizontal_rule';
      let cssClass = 'neutral';
      let text = `${variacao}% vs Mês Ant.`;

      if (variacao > 0) {
        icon = 'arrow_upward';
        cssClass = 'positive';
        text = `+${text}`;
      } else if (variacao < 0) {
        icon = 'arrow_downward';
        cssClass = 'negative';
        // O sinal de menos já está no número
      }
      
      element.className = `kpi-card-variation ${cssClass}`;
      element.innerHTML = `
        <md-icon>${icon}</md-icon>
        <span>${text}</span>
      `;
    }

    /**
     * Desenha todos os gráficos do Google Charts.
     * @param {object} chartsData Dados agregados vindos do backend.
     */
    function drawCharts(chartsData) {
      try {
        // 1. Gráfico de Tendência (Linha)
        drawTendenciaChart(chartsData.tendenciaMensal, chartBaseOptions);
        
        // 2. Gráfico de Finalidades (Barras)
        drawBarChart('chart-finalidade', chartsData.porFinalidade, 'Finalidade', 'Total', chartBaseOptions);
        
        // 3. Gráfico de Status (Barras)
        drawBarChart('chart-status', chartsData.porStatus, 'Status', 'Total', chartBaseOptions);
        
        // 4. Gráfico de OM (Barras)
        drawBarChart('chart-om', chartsData.porOM, 'OM', 'Total', chartBaseOptions);
      } catch (e) {
        console.error("Erro ao desenhar gráficos:", e);
        showError("Erro nos Gráficos", `Não foi possível renderizar os gráficos. Detalhe: ${e.message}`);
      }
    }

    /**
     * Desenha o gráfico de linha de Tendência Mensal.
     */
    function drawTendenciaChart(dataArray, baseOptions) {
      const data = new google.visualization.DataTable();
      data.addColumn('string', 'Mês');
      data.addColumn('number', 'Inspeções');
      data.addRows(dataArray);

      const options = {
        ...baseOptions,
        curveType: 'function',
        pointSize: 5,
        vAxis: { ...baseOptions.vAxis, viewWindow: { min: 0 } }
      };
      
      const chart = new google.visualization.LineChart(document.getElementById('chart-tendencia'));
      chart.draw(data, options);
    }

    /**
     * Desenha um gráfico de barras genérico.
     */
    function drawBarChart(elementId, dataArray, xLabel, yLabel, baseOptions) {
      const data = new google.visualization.DataTable();
      data.addColumn('string', xLabel);
      data.addColumn('number', yLabel);
      data.addRows(dataArray);
      
      data.sort([{ column: 1, desc: true }]);

      const options = {
        ...baseOptions,
        hAxis: { ...baseOptions.hAxis, minValue: 0 },
      };
      
      const chart = new google.visualization.BarChart(document.getElementById(elementId));
      chart.draw(data, options);
    }
    
    // --- ETAPA 5: FRONTEND - TABELA CRUD E LÓGICA ---
    
    /**
     * Renderiza a tabela de dados completa.
     * @param {object[]} tableData Os dados para a tabela.
     */
    function renderTable(tableData) {
      tableHeader.innerHTML = `
        <tr>
          <th>Status</th>
          <th>MSG</th>
          <th>Data (Entrevista)</th>
          <th>Inspecionado</th>
          <th>Finalidade</th>
          <th>Ações</th>
        </tr>
      `;
      
      tableBody.innerHTML = ''; 
      
      if (tableData.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="6">Nenhum dado encontrado para os filtros selecionados.</td></tr>';
        return;
      }
      
      tableData.forEach(row => {
        const tr = document.createElement('tr');
        tr.dataset.rowIndex = row.rowIndex; 
        tr.innerHTML = renderTableRow(row);
        tableBody.appendChild(tr);
      });
      
      console.log("Tabela CRUD renderizada com sucesso.");
    }
    
    /**
     * Gera o HTML interno para uma única linha <tr>.
     * @param {object} row Dados da linha.
     * @returns {string} HTML para os <td>s da linha.
     */
    function renderTableRow(row) {
      return `
        <td>${row.StatusIS || '-'}</td>
        <td>${row.MSG || '-'}</td>
        <td>${formatDate(row.DataEntrevista)}</td>
        <td>
          <div>${row.Inspecionado || 'Nome não informado'}</div>
          <small style="color: var(--app-on-surface-variant-color);">${row.NIP || 'NIP não informado'}</small>
        </td>
        <td>${row.Finalidade || '-'}</td>
        <td>
          <div style="position: relative; display: flex; justify-content: center;">
            <md-icon-button id="menu-anchor-${row.rowIndex}">
              <md-icon>more_vert</md-icon>
            </md-icon-button>
            ${renderActionMenu(row)}
          </div>
        </td>
      `;
    }
    
    /**
     * Formata uma data ISO (ou null) para dd/MM/AAAA.
     * @param {string | null} isoString Data em formato ISO.
     * @returns {string} Data formatada ou '-'.
     */
    function formatDate(isoString) {
      if (!isoString) return '-';
      try {
        const date = new Date(isoString);
        date.setMinutes(date.getMinutes() + date.getTimezoneOffset());
        return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
      } catch (e) {
        return '-';
      }
    }
    
    /**
     * (Chain-of-Thought) Implementa a MÁQUINA DE ESTADOS (Lógica de Negócio).
     * @param {object} row Dados da linha.
     * @returns {string} HTML para o <md-menu>.
     */
    function renderActionMenu(row) {
      let menuItems = '';
      const { StatusIS, Laudo, Restricoes, TIS, DS1a, MSG, Finalidade, rowIndex } = row;

      if (MSG === 'ENVIADA') {
        return `
          <md-menu anchor="menu-anchor-${rowIndex}" menu-corner="start-end" quick>
            <md-menu-item disabled>
              <div slot="headline">Bloqueado (MSG Enviada)</div>
            </md-menu-item>
          </md-menu>
        `;
      }
      
      if (StatusIS === 'Agendada') {
        menuItems += `<md-menu-item data-action="REMARCAR_IS">
                        <div slot="headline">Remarcar IS</div>
                      </md-menu-item>`;
      }
      
      if ((StatusIS === 'Agendada' || StatusIS === 'Remarcada') && !Laudo) {
         menuItems += `<md-menu-item data-action="INSERIR_LAUDO">
                        <div slot="headline">Inserir Laudo</div>
                      </md-menu-item>`;
      }
      
      const statusRestricoesOk = ['Agendada', 'Remarcada', 'Concluída'].includes(StatusIS);
      const finalidadeRestricoesOk = ['TÉRMINO DE INCAPACIDADE', 'TÉRMINO DE RESTRIÇÕES', 'VERIFICAÇÃO DE DEFICIÊNCIA FUNCIONAL'].includes(Finalidade);
      if (statusRestricoesOk && finalidadeRestricoesOk && !Restricoes) {
         menuItems += `<md-menu-item data-action="INSERIR_RESTRICOES">
                        <div slot="headline">Inserir Restrições</div>
                      </md-menu-item>`;
      }
      
      if (StatusIS === 'Concluída') {
         menuItems += `<md-menu-item data-action="AUDITORIA">
                        <div slot="headline">Enviar p/ Auditoria</div>
                      </md-menu-item>`;
         menuItems += `<md-menu-item data-action="REVISAO_JSD">
                        <div slot="headline">Enviar p/ Revisão JSD</div>
                      </md-menu-item>`;
      }
      if (StatusIS === 'Auditoria') {
         menuItems += `<md-menu-item data-action="RESTITUIR_AUDITORIA">
                        <div slot="headline">Restituir da Auditoria</div>
                      </md-menu-item>`;
      }
      if (StatusIS === 'JSD') {
         menuItems += `<md-menu-item data-action="RESTITUIR_JSD">
                        <div slot="headline">Restituir da JSD</div>
                      </md-menu-item>`;
      }

      const statusTisOk = ['Concluída', 'Restituída Auditoria', 'Restituída JSD'].includes(StatusIS);
      if (statusTisOk && !TIS) {
         menuItems += `<md-menu-item data-action="INSERIR_TIS">
                        <div slot="headline">Inserir Nº TIS</div>
                      </md-menu-item>`;
      }
      
      if (StatusIS === 'Votada JRS' && !DS1a) {
         menuItems += `<md-menu-item data-action="INSERIR_DS1A">
                        <div slot="headline">Inserir Código DS-1a</div>
                      </md-menu-item>`;
      }
      
      if (StatusIS === 'TIS Assinado' && MSG === 'PENDENTE') {
         menuItems += `<md-menu-item data-action="REGISTRAR_MSG">
                        <div slot="headline">Registrar MSG Enviada</div>
                      </md-menu-item>`;
      }

      if (menuItems === '') {
        menuItems = `<md-menu-item disabled><div slot="headline">Nenhuma ação disponível</div></md-menu-item>`;
      }

      return `<md-menu anchor="menu-anchor-${rowIndex}" menu-corner="start-end" quick>${menuItems}</md-menu>`;
    }

    /**
     * Configura listeners de eventos para o CRUD (delegação e modal).
     */
    function setupCrudListeners() {
      // 1. Delegação de eventos na tabela
      tableBody.addEventListener('click', (e) => {
        const menuItem = e.target.closest('md-menu-item');
        if (menuItem && menuItem.dataset.action) {
          const action = menuItem.dataset.action;
          const rowEl = menuItem.closest('tr');
          const rowIndex = parseInt(rowEl.dataset.rowIndex, 10);
          const rowData = appData.table.find(r => r.rowIndex === rowIndex);
          
          if (rowData) {
            openCrudDialog(action, rowData);
          } else {
            showError("Erro Interno", `Não foi possível encontrar os dados para a linha ${rowIndex}.`);
          }
        }
        
        const iconButton = e.target.closest('md-icon-button');
        if (iconButton && iconButton.id.startsWith('menu-anchor-')) {
          const menu = iconButton.nextElementSibling;
          if (menu && menu.tagName === 'MD-MENU') {
            menu.open = !menu.open;
          }
        }
      });
      
      // 2. Listener para o botão Salvar do modal
      crudDialogSaveButton.addEventListener('click', handleCrudSave);

      // --- ETAPA 6.B ---
      // 3. Delegação de evento para o botão "Sugerir Laudo" DENTRO do modal
      crudDialogForm.addEventListener('click', (e) => {
        const sugerirButton = e.target.closest('#btn-sugerir-laudo');
        if (sugerirButton) {
          handleSugerirLaudo(sugerirButton);
        }
      });
      // --- FIM ETAPA 6.B ---
    }

    /**
     * Abre e configura o <md-dialog> para a ação CRUD específica.
     * @param {string} action A ação (ex: 'INSERIR_LAUDO').
     * @param {object} rowData Os dados da linha selecionada.
     */
    function openCrudDialog(action, rowData) {
      let title = "Editar Inspeção";
      let formHtml = "";
      
      crudDialogForm.dataset.action = action;
      crudDialogForm.dataset.rowIndex = rowData.rowIndex;
      // --- ETAPA 6.B: Armazena dados da linha para o Assessor ---
      crudDialogForm.dataset.rowData = JSON.stringify(rowData);
      // --- FIM ETAPA 6.B ---

      // Gera o formulário interno do modal
      switch (action) {
        case 'REMARCAR_IS':
          title = "Remarcar Inspeção";
          formHtml = `<md-outlined-text-field label="Nova Data da Entrevista" type="date" id="crud-nova-data" required></md-outlined-text-field>`;
          break;
          
        case 'INSERIR_LAUDO':
          title = "Inserir Laudo";
          formHtml = `
            <md-outlined-text-field label="Texto do Laudo" type="textarea" rows="5" id="crud-laudo" required></md-outlined-text-field>
            
            <!-- ETAPA 6.B: Botão de Sugestão -->
            <div style="margin-top: 16px; text-align: right;">
              <md-linear-progress indeterminate id="laudo-loading" style="display: none; margin-bottom: 8px;"></md-linear-progress>
              <md-outlined-button id="btn-sugerir-laudo">
                <md-icon slot="icon">psychology_alt</md-icon>
                Sugerir Laudo (Assessor)
              </md-outlined-button>
            </div>
          `;
          break;
          
        case 'INSERIR_RESTRICOES':
          title = "Inserir Restrições";
          const restricoesOptions = appData.ref.restricoes || [];
          formHtml = `
            <md-outlined-select label="Restrições (selecione uma ou mais)" id="crud-restricoes" multiple required>
              ${restricoesOptions.map(r => `<md-select-option value="${r}"><div slot="headline">${r}</div></md-select-option>`).join('')}
            </md-outlined-select>
          `;
          break;
          
        case 'INSERIR_TIS':
          title = "Inserir Número TIS";
          formHtml = `<md-outlined-text-field label="Nº TIS (ex: 000.000.00000)" id="crud-tis" pattern="[0-9]{3}\.[0-9]{3}\.[0-9]{5}" required></md-outlined-text-field>`;
          break;
          
        case 'INSERIR_DS1A':
          title = "Inserir Código DS-1a";
          formHtml = `<md-outlined-text-field label="Código DS-1a" id="crud-ds1a" required></md-outlined-text-field>`;
          break;
          
        case 'AUDITORIA':
        case 'RESTITUIR_AUDITORIA':
        case 'REVISAO_JSD':
        case 'RESTITUIR_JSD':
        case 'REGISTRAR_MSG':
          title = "Confirmar Ação";
          const actionText = action.replace(/_/g, ' ').toLowerCase();
          formHtml = `<p>Tem certeza que deseja <strong>${actionText}</strong> para esta inspeção?</p>`;
          break;
          
        default:
          showError("Ação Desconhecida", `A ação '${action}' não possui um formulário.`);
          return;
      }
      
      crudDialogTitle.textContent = title;
      crudDialogForm.innerHTML = formHtml;
      crudDialog.show();
    }
    
    /**
     * Coleta os dados do <md-dialog> e chama o backend (google.script.run).
     */
    function handleCrudSave() {
      const { action, rowIndex } = crudDialogForm.dataset;
      
      let payload = {
        rowIndex: parseInt(rowIndex, 10)
      };
      
      // Coleta os dados do formulário com base na ação
      try {
        switch (action) {
          case 'REMARCAR_IS':
            payload.novaData = document.getElementById('crud-nova-data').value;
            if (!payload.novaData) throw new Error("A nova data é obrigatória.");
            break;
          case 'INSERIR_LAUDO':
            payload.laudo = document.getElementById('crud-laudo').value;
            if (!payload.laudo) throw new Error("O texto do laudo é obrigatório.");
            break;
          case 'INSERIR_RESTRICOES':
            payload.restricoes = document.getElementById('crud-restricoes').value;
            if (!payload.restricoes || payload.restricoes.length === 0) throw new Error("Selecione ao menos uma restrição.");
            break;
          case 'INSERIR_TIS':
            payload.tis = document.getElementById('crud-tis').value;
            if (!payload.tis) throw new Error("O número TIS é obrigatório.");
            break;
          case 'INSERIR_DS1A':
            payload.ds1a = document.getElementById('crud-ds1a').value;
            if (!payload.ds1a) throw new Error("O código DS-1a é obrigatório.");
            break;
          case 'AUDITORIA':
          case 'RESTITUIR_AUDITORIA':
          case 'REVISAO_JSD':
          case 'RESTITUIR_JSD':
          case 'REGISTRAR_MSG':
            break;
        }
      } catch(e) {
        showError("Erro de Validação", e.message);
        return; // Não fecha o modal
      }

      console.log(`Enviando ação CRUD: ${action}`, payload);
      showLoading(true);
      
      google.script.run
        .withSuccessHandler(onCrudSuccess)
        .withFailureHandler(onApiFailure)
        .executeCrudAction(action, payload);
    }
    
    /**
     * Callback de sucesso para o executeCrudAction.
     * @param {object} response O objeto de sucesso do backend.
     */
    function onCrudSuccess(response) {
      console.log("Ação CRUD bem-sucedida:", response.message);
      crudDialog.close(); // Fecha o modal
      loadDashboardData(); // Recarrega todos os dados
    }

    // --- ETAPA 6.B: Funções do Assessor de Laudo (CRUD) ---

    /**
     * [ETAPA 6.B] Pega os dados do modal e chama o backend para sugerir um laudo.
     */
    function handleSugerirLaudo(button) {
      console.log("[Etapa 6.B] Solicitando sugestão de laudo...");
      const laudoLoading = document.getElementById('laudo-loading');
      const laudoTextarea = document.getElementById('crud-laudo');
      
      try {
        const rowData = JSON.parse(crudDialogForm.dataset.rowData);
        if (!rowData) {
          showError("Erro Interno", "Não foi possível ler os dados da linha para o Assessor.");
          return;
        }

        button.disabled = true;
        laudoLoading.style.display = 'block';
        
        google.script.run
          .withSuccessHandler(sugestao => onSugestaoLaudoSuccess(sugestao, button, laudoLoading, laudoTextarea))
          .withFailureHandler(error => onSugestaoLaudoFailure(error, button, laudoLoading))
          .getSugestaoDeLaudo(rowData.Finalidade, rowData);

      } catch (e) {
        showError("Erro ao Sugerir", `Falha ao preparar dados para o Assessor: ${e.message}`);
      }
    }
    
    /**
     * [ETAPA 6.B] Callback de sucesso para getSugestaoLaudo.
     */
    function onSugestaoLaudoSuccess(sugestao, button, laudoLoading, laudoTextarea) {
      console.log("[Etapa 6.B] Sugestão recebida.");
      laudoLoading.style.display = 'none';
      button.disabled = false;
      laudoTextarea.value = sugestao; // Preenche o textarea
    }

    /**
     * [ETAPA 6.B] Callback de falha para getSugestaoLaudo.
     */
    function onSugestaoLaudoFailure(error, button, laudoLoading) {
      console.error("[Etapa 6.B] Falha ao sugerir laudo:", error.message);
      laudoLoading.style.display = 'none';
      button.disabled = false;
      showError("Erro do Assessor", error.message);
    }

    // --- Funções Auxiliares (Helpers) ---

    /**
     * Mostra ou esconde o overlay de loading global.
     * @param {boolean} visible True para mostrar, false para esconder.
     */
    function showLoading(visible) {
      loadingOverlay.classList.toggle('visible', visible);
    }

    /**
     * Mostra o diálogo de erro.
     * @param {string} title Título do erro.
     * @param {string} message Mensagem de erro.
     */
    function showError(title, message) {
      errorDialog.headline = title;
      errorDialogMessage.textContent = message;
      errorDialog.show();
    }

    /**
     * Popula um <md-outlined-select> com opções.
     * @param {string} selectId ID do elemento select.
     * @param {string[]} optionsArray Array de strings para as opções.
     * @param {string} placeholder Texto da primeira opção (ex: "Todos").
     */
    function populateSelect(selectId, optionsArray, placeholder) {
      const select = document.getElementById(selectId);
      if (!select) return;
      
      while (select.children.length > 1) {
        select.removeChild(select.lastChild);
      }
      
      for (const option of optionsArray) {
        const optionEl = document.createElement('md-select-option');
        optionEl.value = option;
        optionEl.innerHTML = `<div slot="headline">${option}</div>`;
        select.appendChild(optionEl);
      }
    }

    /**
     * Retorna o intervalo de datas padrão (1º dia do mês até hoje).
     * @returns {{startDate: string, endDate: string}} Datas formatadas como YYYY-MM-DD.
     */
    function getDefaultDateRange() {
      const today = new Date();
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      
      const endDate = today.toISOString().split('T')[0];
      const startDate = firstDay.toISOString().split('T')[0];
      
      return { startDate, endDate };
    }

  </script>

</body>
</html>
